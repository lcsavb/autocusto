{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/processos.css' %}">

<!-- Include PDF Modal -->
{% include 'components/pdf_modal.html' %}

<div class="container-fluid toast-enabled">
  <form method="POST" novalidate x-data="{ loading: false }" @submit.prevent="loading = true; $refs.submitBtn.disabled = true; fetch(window.location.pathname, { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'Accept': 'application/json' }, body: new FormData($el) }).then(async resp => { let data = await resp.json(); console.log('[DEBUG] AJAX submit response', data); if (data.success) { if (data.pdf_url) { $dispatch('open-pdf', { url: data.pdf_url, title: 'PDF Gerado', allowDownload: true, allowEdit: true }); document.addEventListener('modal-closed', function() { window.location.href = '/'; }, { once: true }); } else { window.ToastSystem.error('PDF não gerado.'); } } else { if (data.form_errors) { const errorMessages = []; Object.values(data.form_errors).forEach(fieldErrors => { fieldErrors.forEach(error => errorMessages.push(error)); }); window.ToastSystem.addSummaryToast(errorMessages, 'error'); } else { window.ToastSystem.error(data.error || 'Erro desconhecido'); } } }).catch(e => { console.error('[DEBUG] AJAX submit error', e); window.ToastSystem.error('Erro de rede: ' + e.message); }).finally(() => { loading = false; $refs.submitBtn.disabled = false; });">
{% csrf_token %}

    <div class="card rounded" style="padding: 1.5rem;">   
      
      <!-- Compact Process Header -->
      <div class="process-header">
        <div class="row align-items-center">
          <div class="col-md-8">
            {% if paciente_existe %}
            <h4>
              <span class="oi oi-plus mr-2"></span>
              Novo Processo
            </h4>
            <p class="subtitle">
              <span class="oi oi-person mr-1"></span>
              {{ paciente.nome_paciente }}
            </p>
            {% else %}
            <h4>
              <span class="oi oi-person mr-2"></span>
              Cadastro de Paciente
            </h4>
            <p class="subtitle">
              Complete os dados do paciente para criar um novo processo
            </p>
            {% endif %}
          </div>
          <div class="col-md-4">
            <div class="header-controls justify-content-end">
              <!-- Protocol Consultation Link -->
              <div x-data>
                <button type="button" class="protocol-link" 
                        @click="console.log('[DEBUG] Consultar Protocolo clicked', {
                          url: '{{ link_protocolo }}',
                          title: 'Protocolo - Novo Processo',
                          allowDownload: true
                        }); $dispatch('open-pdf', { 
                          url: '{{ link_protocolo }}', 
                          title: 'Protocolo - Novo Processo',
                          allowDownload: true 
                        })">
                  <span class="oi oi-document mr-1"></span>
                  Consultar Protocolo
                </button>
              </div>
              <!-- Compact Date -->
              <div class="date-badge">
                <span class="oi oi-calendar mr-1"></span>
                {{ formulario.data_1|as_crispy_field }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Patient Information Section -->
      <div class="section-card">
        <div class="section-header">
          <span class="oi oi-person mr-2"></span>
          Dados do Paciente
        </div>
        <div class="section-body">
          <!-- Hidden CPF field -->
          <div class="row mb-3 d-none">
            <div class="col-md-3">{{ formulario.cpf_paciente|as_crispy_field }}</div>
          </div>

          <!-- Patient Name first -->
          <div class="row mb-3">
            <div class="col-md-8">{{ formulario.nome_paciente|as_crispy_field }}</div>
            <div class="col-md-4">{{ formulario.altura|as_crispy_field }}</div>
          </div>

          <div class="row mb-3">
            <div class="col-md-8">{{ formulario.nome_mae|as_crispy_field }}</div>
            <div class="col-md-4">{{ formulario.peso|as_crispy_field }}</div>
          </div>

          <div class="row mb-3">
            <div class="col-12">{{ formulario.end_paciente|as_crispy_field }}</div>
          </div>

          <!-- É incapaz last, with better alignment -->
          <div class="row">
            <div class="col-md-3">{{ formulario.incapaz|as_crispy_field }}</div>
            <div class="col-md-9 {{ responsavel_mostrar }}" id="resp-escondido">{{ formulario.nome_responsavel|as_crispy_field }}</div>
          </div>
        </div>
      </div>

      <!-- Process Data Section -->
      <div class="section-card">
        <div class="section-header">
          <span class="oi oi-cog mr-2"></span>
          Dados do Processo
        </div>
        <div class="section-body">
          <div class="row mb-3">
            <div class="col-12">{{ formulario.clinicas|as_crispy_field }}</div>
          </div>

          <div class="row mb-3">
            <div class="col-md-2">{{ formulario.cid|as_crispy_field }}</div>
            <div class="col-md-10">{{ formulario.diagnostico|as_crispy_field }}</div>
          </div>

          <div class="row">
            <div class="col-12">{{ formulario.anamnese|as_crispy_field }}</div>
          </div>
        </div>
      </div>
            <!-- Medicamentos -->
            {% include 'processos/form_med.html' %}

      <!-- Treatment History Section -->
      <div class="section-card">
        <div class="section-header">
          <span class="oi oi-medical-cross mr-2"></span>
          Histórico de Tratamentos
        </div>
        <div class="section-body">
          <div class="row mb-3">
            <div class="col-md-6">{{ formulario.preenchido_por|as_crispy_field }}</div>
          </div>
          <div class="row mb-3 campo-18 {{ campo_18_mostrar }}">
            <div class="col-md-3">{{ formulario.etnia|as_crispy_field }}</div>
            <div class="col-md-3">{{ formulario.telefone1_paciente|as_crispy_field }}</div>
            <div class="col-md-3">{{ formulario.telefone2_paciente|as_crispy_field }}</div>
            <div class="col-md-3">{{ formulario.email_paciente|as_crispy_field }}</div>
          </div>
          <div class="row">
            <div class="col-md-4">{{ formulario.tratou|as_crispy_field }}</div>
            <div class="col-md-8 d-none" id="trat-escondido">{{ formulario.tratamentos_previos|as_crispy_field }}</div>
          </div>
        </div>
      </div>

      <!-- Conditional Fields Section -->
      {% if campos_condicionais %}
      <div class="section-card">
        <div class="section-header">
          <span class="oi oi-list mr-2"></span>
          Campos Específicos da Doença
        </div>
        <div class="section-body">
          {% include 'processos/campos_condicionais.html' %}
        </div>
      </div>
      {% endif %}

      <!-- Additional Documents -->
      {% include 'processos/docs_adicionais.html' %}

      <!-- Submit Section -->
      <div class="submit-section">
        <button class="btn btn-submit-process" type="submit" x-ref="submitBtn" :disabled="loading">
          <span class="oi oi-plus mr-2"></span>
          <span x-show="!loading">Cadastrar Processo</span>
          <span x-show="loading">Enviando...</span>
        </button>
        <p class="text-muted mt-2 mb-0">
          <small>Clique para criar o novo processo</small>
        </p>
      </div>
    </div>    

  </form>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js" integrity="sha256-Kg2zTcFO9LXOc7IwcBx1YeUBJmekycsnTsq2RuFHSZU=" crossorigin="anonymous"></script>
<script src="{% static 'js/pdf-modal.js' %}"></script>
<script src="{% static 'processos/js/processo.js' %}"></script>
<script src="{% static 'processos/js/mascaras.js' %}"></script>
<script src="{% static 'processos/js/med.js' %}"></script>
<script src="{% static 'processos/js/documentosAdicionais.js' %}"></script>
<script src="{% static 'processos/js/emitirExames.js' %}"></script>
{% endblock %}